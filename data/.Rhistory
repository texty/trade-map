library("readxl")
library("xlsx")
library('dplyr')
library('lubridate')
library('stringr')
library("tidyr")
eu_path = '/home/yevheniia/R/2019/october/food_exports_imports/version2/data/EU_countries/'
data_path = '/home/yevheniia/R/2019/october/food_exports_imports/version2/data/'
e_total_files = list.files(data_path, pattern = "^E_total")
i_total_files = list.files(data_path, pattern = "^I_total")
e_eu_files = list.files(eu_path, pattern = "^E_")
i_eu_files = list.files(eu_path, pattern = "^I_")
e_ru_files = list.files(data_path, pattern = "^E_RU")
i_ru_files = list.files(data_path, pattern = "^I_RU")
library("readxl")
library("xlsx")
library('dplyr')
library('lubridate')
library('stringr')
library("tidyr")
eu_path = '/home/yevheniia/R/2019/october/food_exports_imports/version2/data/EU_countries/'
data_path = '/home/yevheniia/R/2019/october/food_exports_imports/version2/data/'
e_total_files = list.files(data_path, pattern = "^E_total")
i_total_files = list.files(data_path, pattern = "^I_total")
e_eu_files = list.files(eu_path, pattern = "^E_")
i_eu_files = list.files(eu_path, pattern = "^I_")
e_ru_files = list.files(data_path, pattern = "^E_RU")
i_ru_files = list.files(data_path, pattern = "^I_RU")
#  функція читає xls та додає до них назву країни і тип торгівлі - експорт чи імпорт
readFiles = function(x, path) {
setwd(path)
meta = read.xlsx(x, sheetIndex=1, startRow=11, endRow=12, header=FALSE, as.data.frame=TRUE) %>%
select(3) %>%
slice(1) %>%
mutate(X3 = as.character(X3))
read.xlsx(x, sheetIndex = 1,  startRow=12, header=TRUE, as.data.frame=TRUE) %>%
select(1:20) %>%
# rename_all(recode, NA. = "code", NA..1 = "product") %>%
rename("code" = 1) %>%
rename("product" = 2) %>%
mutate(type = sub(' to.*| from.*', '', meta$X3)) %>%
mutate(type = sub("Ukraine's ", '', type)) %>%
mutate(country = sub("Ukraine's exports to |Ukraine's imports from", '', meta$X3)) %>%
mutate(code = sub("^'", '', code)) %>%
gather(3:20, key = year, value = thousdol) %>%
mutate(year = gsub("[^0-9]", "", year))
}
# читаємо всі файли в один і прибираємо рядки зі значенням 0
# загальні
e = do.call(rbind, lapply(e_total_files, readFiles, data_path)) %>% filter(thousdol != 0)
i = do.call(rbind, lapply(i_total_files, readFiles, data_path)) %>% filter(thousdol != 0)
View(e)
# ЄС
e_eu = do.call(rbind, lapply(e_eu_files, readFiles, eu_path)) %>% filter(thousdol != 0)
i_eu = do.call(rbind, lapply(i_eu_files, readFiles, eu_path)) %>% filter(thousdol != 0)
# Росія
e_ru = do.call(rbind, lapply(e_ru_files, readFiles, data_path)) %>% filter(thousdol != 0)
i_ru = do.call(rbind, lapply(i_ru_files, readFiles, data_path)) %>% filter(thousdol != 0)
# функція узагальнення даних по всіх продуктах
get_total_of_type = function(data, countryName) {
data = data %>%
mutate(year = as.numeric(year)) %>%
filter(case_when(country == "Hungary" |
country == "Cyprus" |
country == "Estonia"|
country == "Latvia"|
country == "Lithuania"|
country == "Poland"|
country == "Slovakia"|
country == "Czech Republic"|
country == "Malta"|
country == "Slovenia" ~ year > 2003, T ~ year > 2000)) %>%
filter(case_when(country == "Bulgaria" |
country == "Romania" ~ year > 2006, T ~ year > 2000)) %>%
filter(case_when(country == "Croatia" ~ year > 2012, T ~ year > 2000))
# Дані по країні по всіх продуктах
eu_total = data %>%
filter(code == 'TOTAL') %>%
group_by(year, code, product, type) %>%
summarize(thousdol = sum(thousdol)) %>%
ungroup() %>%
mutate(country = countryName)
return(data.frame(eu_total))
}
# total of total
total_total_e = get_total_of_type(e, "all")
total_total_i = get_total_of_type(i, "all")
# всі країни ЄС по всіх продуктах
eu_total_e = get_total_of_type(e_eu, "ЄС")
eu_total_i = get_total_of_type(i_eu, "ЄС")
# Росія по всіх продуктах
ru_total_e = get_total_of_type(e_ru, "Росія")
ru_total_i = get_total_of_type(i_ru, "Росія")
# функція для отримання ТОП-5
get_top_of_type = function(data, countryName) {
# прибираємо країни ЄС яких не було в ЄС в зазанчений рік
data = data %>%
mutate(year = as.numeric(year)) %>%
filter(case_when(country == "Hungary" |
country == "Cyprus" |
country == "Estonia"|
country == "Latvia"|
country == "Lithuania"|
country == "Poland"|
country == "Slovakia"|
country == "Czech Republic"|
country == "Malta"|
country == "Slovenia" ~ year > 2003, T ~ year > 2000)) %>%
filter(case_when(country == "Bulgaria" |
country == "Romania" ~ year > 2006, T ~ year > 2000)) %>%
filter(case_when(country == "Croatia" ~ year > 2012, T ~ year > 2000))
# Дані по країні по всіх продуктах
eu_total = data %>% filter(code == 'TOTAL')
# Дані по країні з розбивкою на продукти, будемо визначати топ-5 продуктів
eu_countries = data %>%
filter(code != 'TOTAL') %>%
mutate(year = as.numeric(year)) %>%
mutate(product = as.character(product))
# прибираємо розбивку на країни, нам цікава торгівля з цілим ЄС
# далі залишаємо тільки ті продукти, що входили в ТОП-5 в різні роки
eu_type_data = eu_countries %>%
group_by(year, code, product, type) %>%
summarize(thousdol = sum(thousdol)) %>%
ungroup() %>%
mutate(country = countryName)
# маємо перелік продуктів, які побували в топ-5 за 17 років
eu_top5_type = eu_type_data %>%
group_by(year) %>%
top_n(n = 5, wt = thousdol) %>%
ungroup()
# витянуємо дані за кожен рік для кожного продукту з топ5
eu_top5_type_data = subset(eu_type_data, product %in% eu_top5_type$product)
return(data.frame(eu_top5_type_data))
}
# дані по всіх продуктах і країнах
total_data = rbind(total_total_e, total_total_i, eu_total_e, eu_total_i, ru_total_e, ru_total_i)
View(total_data)
View(e)
library("readxl")
library("xlsx")
library('dplyr')
library('lubridate')
library('stringr')
library("tidyr")
eu_path = '/home/yevheniia/R/2019/october/food_exports_imports/version2/data/EU_countries/'
data_path = '/home/yevheniia/R/2019/october/food_exports_imports/version2/data/'
e_total_files = list.files(data_path, pattern = "^E_total")
i_total_files = list.files(data_path, pattern = "^I_total")
e_eu_files = list.files(eu_path, pattern = "^E_")
i_eu_files = list.files(eu_path, pattern = "^I_")
e_ru_files = list.files(data_path, pattern = "^E_RU")
i_ru_files = list.files(data_path, pattern = "^I_RU")
#  функція читає xls та додає до них назву країни і тип торгівлі - експорт чи імпорт
readFiles = function(x, path) {
setwd(path)
meta = read.xlsx(x, sheetIndex=1, startRow=11, endRow=12, header=FALSE, as.data.frame=TRUE) %>%
select(3) %>%
slice(1) %>%
mutate(X3 = as.character(X3))
read.xlsx(x, sheetIndex = 1,  startRow=12, header=TRUE, as.data.frame=TRUE) %>%
select(1:20) %>%
# rename_all(recode, NA. = "code", NA..1 = "product") %>%
rename("code" = 1) %>%
rename("product" = 2) %>%
mutate(type = sub(' to.*| from.*', '', meta$X3)) %>%
mutate(type = sub("Ukraine's ", '', type)) %>%
mutate(country = sub("Ukraine's exports to |Ukraine's imports from", '', meta$X3)) %>%
mutate(code = sub("^'", '', code)) %>%
gather(3:20, key = year, value = thousdol) %>%
mutate(year = gsub("[^0-9]", "", year))
}
# читаємо всі файли в один і прибираємо рядки зі значенням 0
# загальні
e = do.call(rbind, lapply(e_total_files, readFiles, data_path)) %>% filter(thousdol != 0)
i = do.call(rbind, lapply(i_total_files, readFiles, data_path)) %>% filter(thousdol != 0)
# ЄС
e_eu = do.call(rbind, lapply(e_eu_files, readFiles, eu_path)) %>% filter(thousdol != 0)
i_eu = do.call(rbind, lapply(i_eu_files, readFiles, eu_path)) %>% filter(thousdol != 0)
# Росія
e_ru = do.call(rbind, lapply(e_ru_files, readFiles, data_path)) %>% filter(thousdol != 0)
i_ru = do.call(rbind, lapply(i_ru_files, readFiles, data_path)) %>% filter(thousdol != 0)
# функція узагальнення даних по всіх продуктах
get_total_of_type = function(data, countryName) {
data = data %>%
mutate(year = as.numeric(year)) %>%
filter(case_when(country == "Hungary" |
country == "Cyprus" |
country == "Estonia"|
country == "Latvia"|
country == "Lithuania"|
country == "Poland"|
country == "Slovakia"|
country == "Czech Republic"|
country == "Malta"|
country == "Slovenia" ~ year > 2003, T ~ year > 2000)) %>%
filter(case_when(country == "Bulgaria" |
country == "Romania" ~ year > 2006, T ~ year > 2000)) %>%
filter(case_when(country == "Croatia" ~ year > 2012, T ~ year > 2000))
# Дані по країні по всіх продуктах
eu_total = data %>%
filter(code == 'TOTAL') %>%
group_by(year, code, product, type) %>%
summarize(thousdol = sum(thousdol)) %>%
ungroup() %>%
mutate(country = countryName)
return(data.frame(eu_total))
}
# total of total
total_total_e = get_total_of_type(e, "all")
total_total_i = get_total_of_type(i, "all")
# всі країни ЄС по всіх продуктах
eu_total_e = get_total_of_type(e_eu, "ЄС")
eu_total_i = get_total_of_type(i_eu, "ЄС")
# Росія по всіх продуктах
ru_total_e = get_total_of_type(e_ru, "Росія")
ru_total_i = get_total_of_type(i_ru, "Росія")
# дані по всіх продуктах і країнах
total_data = rbind(total_total_e, total_total_i, eu_total_e, eu_total_i, ru_total_e, ru_total_i)
# функція для отримання ТОП-5
get_top_of_type = function(data, countryName) {
# прибираємо країни ЄС яких не було в ЄС в зазанчений рік
data = data %>%
mutate(year = as.numeric(year)) %>%
filter(case_when(country == "Hungary" |
country == "Cyprus" |
country == "Estonia"|
country == "Latvia"|
country == "Lithuania"|
country == "Poland"|
country == "Slovakia"|
country == "Czech Republic"|
country == "Malta"|
country == "Slovenia" ~ year > 2003, T ~ year > 2000)) %>%
filter(case_when(country == "Bulgaria" |
country == "Romania" ~ year > 2006, T ~ year > 2000)) %>%
filter(case_when(country == "Croatia" ~ year > 2012, T ~ year > 2000))
# Дані по країні по всіх продуктах
eu_total = data %>% filter(code == 'TOTAL')
# Дані по країні з розбивкою на продукти, будемо визначати топ-5 продуктів
eu_countries = data %>%
filter(code != 'TOTAL') %>%
mutate(year = as.numeric(year)) %>%
mutate(product = as.character(product))
# прибираємо розбивку на країни, нам цікава торгівля з цілим ЄС
# далі залишаємо тільки ті продукти, що входили в ТОП-5 в різні роки
eu_type_data = eu_countries %>%
group_by(year, code, product, type) %>%
summarize(thousdol = sum(thousdol)) %>%
ungroup() %>%
mutate(country = countryName)
# маємо перелік продуктів, які побували в топ-5 за 17 років
eu_top5_type = eu_type_data %>%
group_by(year) %>%
top_n(n = 5, wt = thousdol) %>%
ungroup()
# витянуємо дані за кожен рік для кожного продукту з топ5
eu_top5_type_data = subset(eu_type_data, product %in% eu_top5_type$product)
return(data.frame(eu_top5_type_data))
}
# дані за всі роки по топ-5 товарів
eu_top5_export_data = get_top_of_type(e_eu, "ЄС")
eu_top5_import_data = get_top_of_type(i_eu, "ЄС")
ru_top5_export_data = get_top_of_type(e_ru, "Росія")
ru_top5_import_data = get_top_of_type(i_ru, "Росія")
all_top5_export_data = get_top_of_type(e, "all")
all_top5_import_data = get_top_of_type(i, "all")
View(all_top5_export_data)
# дані по топ5 продуктах і ЄС та Росія
top5_data = rbind(all_top5_export_data, all_top5_import_data, eu_top5_export_data, eu_top5_import_data,ru_top5_export_data, ru_top5_import_data)
# дані для лайнЧарта без "Цікавих фактів"
lineChart_data = rbind(total_data, top5_data)
lineChart_data =  spread(lineChart_data, type, thousdol) %>%
rename("Exported" = "exports") %>%
rename("Imported" = "imports")
setwd("/home/yevheniia/git/import-export/data")
setwd("/home/yevheniia/git/import-export/data")
write.csv(lineChart_data, "newLineChartData.csv", row.names = F)
